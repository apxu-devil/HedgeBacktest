{
    "contents" : "\nrequire(fOptions)\nrequire(xts)\nrequire(dplyr)\nrequire(ggplot2)\nrequire(scales)\nrequire(grid)\nrequire(gridExtra)\nrequire(foreach)\nrequire(TTR)\n\n# Final data preparations\nload('rub.RData')\nrub3m = rub[, c('rub', 'swap3m', 'iv3m')]\nnames(rub3m) = c('rub', 'swap', 'iv')\n\n\ndays = 90\notm = 0\n\n#\n# 3m options prices every day\n# \n\nrub3m$call = rub3m %>% \n  as.data.frame %>% \n  mutate(call = GBSOption('c', rub, rub*(1+otm), days/365, 0, swap, iv)@price) %>%\n  select(call) %>% unlist\n\n\n#\n# Maximum PL ration in option live\n# data = data_window\n\nMaxPlRatio = function(data, days = 90, otm = 0, at_exp = F){\n  \n if(at_exp)\n   data = c(data[1], data[length(index(data))]) #calc only the first and the last days\n  \n data$t = last(index(data)) - index(data) #days til exp column\n  \n  strike = as.numeric(data[1, 'rub'] * (1+otm))\n  \n  call_t = data %>% \n    as.data.frame %>% \n    mutate(call_t = GBSOption('c', rub, strike, t/365, 0, swap, iv)@price) %>%\n    select(call_t)\n  \n  call_t = as.numeric(unlist(call_t))\n  \n  pl_ratio = call_t / call_t[1] - 1\n  plr_max = max(pl_ratio)\n  \n  return(plr_max)\n}\n\n#\n# Max PL ratio for all options\n#\n\nAllMaxPlRations = function(data = rub3m, days = 90, otm = 0, at_exp = F){\n  \n  pls_maxs = NULL\n  \n  for(i in 1:(nrow(data)-1) ){ #(nrow(rub3m)-1)\n    \n    day_1 = index(data[i])\n    day_t = day_1 + days\n    \n    if(day_t > last(index(rub3m))) break  #exit loop if last date out of range\n    \n    data_window = data[paste0(day_1,'::',day_t)]\n    \n    pls_max = MaxPlRatio(data_window, days = days, otm = otm, at_exp = at_exp)\n    pls_maxs = c(pls_maxs, pls_max)\n    \n  }\n  \n  return(pls_maxs)\n}\n\n\nday_1 = index(rub3m[1])\nday_t = last(index(rub3m)) - days\nindexs = rub3m[paste0(day_1,'::',day_t)] %>% index\n\n\n\npls_maxs = AllMaxPlRations(at_exp=T)\npls_maxs1 = AllMaxPlRations(at_exp=F)\nplot(pls_maxs)\nplot(pls_maxs1)\n\npls_max_otms = sapply(c(-0.05, 0, 0.05), function(x)AllMaxPlRations(otm=x, at_exp=F)) \n\npls_max_otms = as.data.frame(pls_max_otms) \nas.tbl(pls_max_otms)\npls_max_otms$dates = indexs\n\n\npls_max_otms_g = gather(pls_max_otms, key=otms, value = pl, -dates)\npls_max_otms_g %>% ggvis(~dates,~pl, fill=~otms) %>% layer_lines()\n\nggplot(data = pls_max_otms_g, aes(x=dates, y=pl, color=otms)) + geom_line()\n\nplsm = pls_max_otms$V3\n\n#\n# Target PL Ratio probability\n#\nplr_interv = pretty(plsm, n = 30)\nplr_cuts = cut(plsm, plr_interv, include.lowest=T)\nplr_freq = table(plr_cuts)/length(plsm)\nplr_cumfreq = 1-cumsum(plr_freq)\n\nplot(plr_cumfreq)\n\nplr_n = length(plsm)\nplr_prob = length(plsm[plsm>5]) / plr_n\nplr_prob\n\n\n\n\n\n\n\n# What if we do not hedge?\n\n  usd_diff = diff(rub3m$rub, days*5/7) %>% lag(., k=-days*5/7)\n  usd_roc = usd_diff /  rub3m$rub %>% na.omit\n  usd_roc = ROC(rub3m$rub, days*5/7) %>% na.omit\n  \n  rub3m$usd_roc = ROC(rub3m$rub, days*5/7)\n\n\n# +--------------+\n# | Call result\n# +--------------+\n\n  usd_up = lag.xts(rub3m$rub, k=-days*5/7) - rub3m$rub*(1+otm)  %>% na.omit #usd_diff\n  usd_up[usd_up<0,] = 0\n  \n  call_result = (usd_up - rub3m$call) / rub3m$rub\n  \n  pl = (usd_up - rub3m$call)/rub3m$call\n  \n  #cbind(usd_up,rub3m$call)\n  \n  hist(pl[pl>0])\n  \n  length(pl[pl>0])/length(pl)\n  length(pl[pl>10])/length(pl)\n\n  # Средний прирост доллара за 90 дней:\n\n  usd_roc_df =data.frame(\n    Period = c('All', '2010 - 2013', '2014+'), \n    USD_risk = c(mean(-usd_roc, na.rm = T), \n                 mean(-usd_roc['2010/2013'], na.rm = T), \n                 mean(-usd_roc['2014::'], na.rm = T)),\n    SD = c(sd(usd_roc, na.rm = T), \n           sd(usd_roc['2010/2013'], na.rm=T), \n           sd(usd_roc['2014::']))\n    ) %>% mutate(., variance=SD/USD_risk)\n    \n\n  # Средний результа по коллу за 90 дней:\n \n  call_res_df = data.frame(\n    Period = c('All', '2010 - 2013', '2014+'), \n    Call_result = c(mean(call_result, na.rm = T), \n                    mean(call_result['2010/2013'], na.rm=T), \n                    mean(call_result['2014::'])), \n    SD = c(sd(call_result, na.rm = T), \n           sd(call_result['2010/2013'], na.rm=T), \n           sd(call_result['2014::']))\n    ) %>% mutate(., variance=SD/Call_result)\n  \n\naver_hedge_res = full_join(usd_roc_df, call_res_df, by = 'Period') %>% mutate(Hedged_risk = USD_risk + Call_result)\n\nforeach( i=2:4) %do% {\n  aver_hedge_res[, i] = paste(round(aver_hedge_res[, i]*100, digits = 2), '%', sep='')\n}\n\nnames(aver_hedge_res) = c('Период', 'Валютный риск', 'Результат опциона', 'Хеджированный риск')\nres_grob = tableGrob(aver_hedge_res)\n\n\n#\n# Chart call\n#\n\nfinal_res =  merge(merge(call_result, -usd_diff/rub3m$rub), call_result-usd_diff/rub3m$rub) %>% na.omit\nnames(final_res) = c('Call_Profit', 'USD_risk', 'Hedged')\n\n\nchart2 = ggplot() +  theme_grey(base_size = 18) +\n  geom_area(data=fortify(final_res[,c('Hedged', 'USD_risk')], melt=T), aes(x=Index, y=Value, fill=Series)) + \n  scale_fill_manual(\n    values = c('red', 'black'),\n    name = 'Валютный риск:',\n    labels=c('Захеджированный', 'Без хеджрования')) +\n  scale_y_continuous(labels = percent,\n                     breaks=seq(-1,1,0.2)) +  \n  theme(title = element_text(size=14),\n        legend.position=c(0,0),\n        legend.justification = c(0,0),\n        legend.background = element_blank()) + \n  labs(title = 'Валютные риски импортёра' , x=NULL, y=NULL) +\n  geom_segment(    \n    aes(x=as.Date('2014-01-01'), y=-0.4, xend=as.Date('2014-06-01'), yend=-0.5), \n    arrow = arrow(length = unit(0.2, 'cm'), type = 'closed')) +\n  annotate('text', x=as.Date('2013-03-01'), y=-0.35, label='Рост доллара - риск для импортёра') +\n  geom_segment(    \n    aes(x=as.Date('2011-06-01'), y=0.3, xend=as.Date('2011-01-01'), yend=0.2), \n    arrow = arrow(length = unit(0.2, 'cm'), type = 'closed')) +\n  geom_segment(    \n    aes(x=as.Date('2012-01-01'), y=0.3, xend=as.Date('2012-01-01'), yend=0.2), \n    arrow = arrow(length = unit(0.2, 'cm'), type = 'closed')) +\n  annotate('text', x=as.Date('2011-06-01'), y=0.35, label='Импортёр выигрывает от укрепления рубля')\n\n  \ngrid.arrange(chart2, res_grob, nrow=2, heights=c(1, 0.5))\n\n\n\n\n# +--------------+\n# | Put result\n# +--------------+\n\nrub3m$put  = (as.data.frame(rub3m) %>% mutate(put = GBSOption('p', rub, rub, 90/365, swap, 0, iv)@price))[, c('put')]\n\nusd_down = usd_diff \nusd_down[usd_down>0, ]=0\n\nput_result = (-usd_down - rub3m$put) / rub3m$rub\n\n\n\n\nhedge_res = local({\n  \n  # Средний прирост доллара за 90 дней:\n  usd_roc_df =data.frame(\n    Period = c('All', '2010 - 2013', '2014+'), \n    USD_risk = c(mean(usd_roc, na.rm = T), \n                 mean(usd_roc['2010/2013'], na.rm = T), \n                 mean(usd_roc['2014/2015'], na.rm = T)) )\n  \n  # Средний результа по коллу за 90 дней:\n  \n  put_res_df = data.frame(\n    Period = c('All', '2010 - 2013', '2014+'), \n    Put_result = c(mean(put_result, na.rm = T), \n                    mean(put_result['2010/2013']), \n                    mean(put_result['2014'])))\n  \n  aver_hedge_res = full_join(usd_roc_df, put_res_df, by = 'Period') %>% mutate(Hedged_risk = USD_risk + Put_result)\n  \n  foreach( i=2:4) %do% {\n    aver_hedge_res[, i] = paste(round(aver_hedge_res[, i]  * 100, digits = 2), '%', sep='')\n  }\n  \n  names(aver_hedge_res) = c('Период', 'Валютный риск', 'Результат опциона', 'Хеджированный риск')\n  aver_hedge_res\n  \n})\n\nres_grob_put = tableGrob(hedge_res, name='test')\n\n\n#\n# Chart put\n#\n\nfinal_res_put =  merge(merge(put_result, usd_diff/rub3m$rub), put_result+usd_diff/rub3m$rub) %>% na.omit\nnames(final_res_put) = c('Put_Profit', 'USD_risk', 'Hedged')\n\nlocal({\n  mean(final_res_put$Hedged, na.rm=T)/sd(final_res_put$Hedged, na.rm=T)\n  mean(final_res_put$USD_risk, na.rm=T)/sd(final_res_put$USD_risk, na.rm = T)\n  })\n\nchart3 = ggplot() +  theme_grey(base_size = 18) +\n  geom_area(data=fortify(final_res_put[,c('Hedged', 'USD_risk')], melt=T), aes(x=Index, y=Value, fill=Series)) + \n  scale_fill_manual(\n    values = c('red', 'black'),\n    name = 'Валютный риск:',\n    labels=c('Захеджированный', 'Без хеджрования')) +\n  scale_y_continuous(labels = percent,\n                     breaks=seq(-1,2,0.2)) +  \n  theme(title = element_text(size=14),\n        legend.position=c(0,1),\n        legend.justification = c(0,1),\n        legend.background = element_blank()) + \n  labs(title = 'Валютные риски экспортёра' , x=NULL, y=NULL) +\n  \n  geom_segment(    \n    aes(x=as.Date('2014-01-01'), y=-0.4, xend=as.Date('2014-06-01'), yend=-0.5), \n    arrow = arrow(length = unit(0.2, 'cm'), type = 'closed')) +\n  annotate('text', x=as.Date('2013-03-01'), y=-0.35, label='Рост доллара - риск для импортёра') +\n  geom_segment(    \n    aes(x=as.Date('2011-06-01'), y=0.3, xend=as.Date('2011-01-01'), yend=0.2), \n    arrow = arrow(length = unit(0.2, 'cm'), type = 'closed')) +\n  geom_segment(    \n    aes(x=as.Date('2012-01-01'), y=0.3, xend=as.Date('2012-01-01'), yend=0.2), \n    arrow = arrow(length = unit(0.2, 'cm'), type = 'closed')) +\n  annotate('text', x=as.Date('2011-06-01'), y=0.35, label='Импортёр выигрывает от укрепления рубля')\n\n\ngrid.arrange(chart3, res_grob_put, nrow=2, heights=c(1, 0.5))\n\n\n\n\n\n",
    "created" : 1470585904090.000,
    "dirty" : false,
    "encoding" : "CP1251",
    "folds" : "",
    "hash" : "1358756663",
    "id" : "A553A42B",
    "lastKnownWriteTime" : 1470949102,
    "path" : "~/MyR/HedgeBacktest/callbacktest.R",
    "project_path" : "callbacktest.R",
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "type" : "r_source"
}